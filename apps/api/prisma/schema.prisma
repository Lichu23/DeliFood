generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USUARIOS ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String
  phone         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  ownedStores     Store[]         @relation("StoreOwner")
  memberships     StoreMember[]
  sentInvitations Invitation[]    @relation("InvitationSender")
  assignedOrders  Order[]         @relation("AssignedDelivery")
}

model Store {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  description String?
  logo        String?
  phone       String?
  email       String?
  address     String
  latitude    Float
  longitude   Float
  
  orderMode       OrderMode       @default(IMMEDIATE)
  assignmentMode  AssignmentMode  @default(MANUAL)
  isActive        Boolean         @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  ownerId     String
  owner       User              @relation("StoreOwner", fields: [ownerId], references: [id])
  members     StoreMember[]
  invitations Invitation[]
  settings    StoreSettings?
  categories  Category[]
  products    Product[]
  deliveryZones DeliveryZone[]
  deliverySlots DeliverySlot[]
  blockedDates  BlockedDate[]
  orders      Order[]
}

model StoreSettings {
  id          String    @id @default(cuid())
  storeId     String    @unique
  store       Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  minOrderAmount        Float     @default(0)
  estimatedPrepTime     Int       @default(30)
  
  immediateCancelMinutes  Int     @default(5)
  scheduledCancelHours    Int     @default(24)
  allowCancellation       Boolean @default(true)
  
  minAdvanceHours   Int       @default(24)
  maxAdvanceDays    Int       @default(30)
  
  bankName          String?
  bankAccountHolder String?
  bankAccountNumber String?
  bankAlias         String?
  
  acceptsCash       Boolean   @default(true)
  acceptsTransfer   Boolean   @default(false)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model StoreMember {
  id          String    @id @default(cuid())
  storeId     String
  store       Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  role        Role
  isActive    Boolean   @default(true)
  joinedAt    DateTime  @default(now())
  
  @@unique([storeId, userId])
  @@index([storeId])
  @@index([userId])
}

model Invitation {
  id          String    @id @default(cuid())
  storeId     String
  store       Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  email       String
  role        Role
  token       String    @unique
  expiresAt   DateTime
  usedAt      DateTime?
  
  invitedById String
  invitedBy   User      @relation("InvitationSender", fields: [invitedById], references: [id])
  
  createdAt   DateTime  @default(now())
  
  @@index([token])
  @@index([email, storeId])
}

model Category {
  id          String    @id @default(cuid())
  storeId     String
  store       Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  name        String
  description String?
  image       String?
  sortOrder   Int       @default(0)
  isActive    Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  products    Product[]
  
  @@index([storeId])
}

model Product {
  id          String    @id @default(cuid())
  storeId     String
  store       Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  
  name        String
  description String?
  price       Float
  image       String?
  isAvailable Boolean   @default(true)
  sortOrder   Int       @default(0)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  orderItems  OrderItem[]
  
  @@index([storeId])
  @@index([categoryId])
}

model DeliveryZone {
  id          String    @id @default(cuid())
  storeId     String
  store       Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  name        String
  minDistance Float     @default(0)
  maxDistance Float
  deliveryFee Float     @default(0)
  minOrder    Float     @default(0)
  estimatedTime Int     @default(30)
  isActive    Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([storeId])
}

model DeliverySlot {
  id          String    @id @default(cuid())
  storeId     String
  store       Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  dayOfWeek   Int
  startTime   String
  endTime     String
  maxOrders   Int       @default(5)
  isActive    Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([storeId, dayOfWeek])
}

model BlockedDate {
  id          String    @id @default(cuid())
  storeId     String
  store       Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  date        DateTime  @db.Date
  reason      String?
  
  createdAt   DateTime  @default(now())
  
  @@unique([storeId, date])
}

model Order {
  id          String      @id @default(cuid())
  storeId     String
  store       Store       @relation(fields: [storeId], references: [id])
  orderNumber Int
  
  type        OrderType   @default(IMMEDIATE)
  status      OrderStatus @default(PENDING)
  
  customerName    String
  customerPhone   String
  customerEmail   String?
  customerAddress String
  customerLat     Float
  customerLng     Float
  customerNotes   String?
  
  scheduledDate       DateTime?   @db.Date
  scheduledSlotStart  String?
  scheduledSlotEnd    String?
  
  subtotal        Float
  deliveryFee     Float       @default(0)
  total           Float
  paymentMethod   PaymentMethod @default(CASH)
  paymentStatus   PaymentStatus @default(PENDING)
  paymentProof    String?
  
  estimatedMinutes  Int?
  
  assignedToId    String?
  assignedTo      User?       @relation("AssignedDelivery", fields: [assignedToId], references: [id])
  assignedAt      DateTime?
  
  cancelledAt     DateTime?
  cancelReason    String?
  cancelledBy     CancelledBy?
  refundStatus    RefundStatus?
  
  confirmedAt     DateTime?
  preparingAt     DateTime?
  readyAt         DateTime?
  onTheWayAt      DateTime?
  deliveredAt     DateTime?
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  items           OrderItem[]
  
  @@unique([storeId, orderNumber])
  @@index([storeId, status])
  @@index([storeId, scheduledDate])
  @@index([assignedToId, status])
  @@index([storeId, createdAt])
}

model OrderItem {
  id          String    @id @default(cuid())
  orderId     String
  order       Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String?
  product     Product?  @relation(fields: [productId], references: [id], onDelete: SetNull)
  
  name        String
  quantity    Int
  unitPrice   Float
  totalPrice  Float
  notes       String?
  
  @@index([orderId])
}

enum Role {
  OWNER
  ADMIN
  CASHIER
  DELIVERY
}

enum OrderMode {
  IMMEDIATE
  SCHEDULED
  HYBRID
}

enum AssignmentMode {
  SINGLE
  MANUAL
  AUTO
  BROADCAST
}

enum OrderType {
  IMMEDIATE
  SCHEDULED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  ON_THE_WAY
  DELIVERED
  CANCELLED
}

enum PaymentMethod {
  CASH
  TRANSFER
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  REFUNDED
}

enum CancelledBy {
  CUSTOMER
  STORE
  SYSTEM
}

enum RefundStatus {
  NOT_REQUIRED
  PENDING
  COMPLETED
}